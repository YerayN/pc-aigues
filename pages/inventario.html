<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intranet PC Aig√ºes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f0f0f0; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: #d35400; }
        
        /* ‚ö° NUEVO: Estilos para el formulario de a√±adir */
        .formulario-add { background: #eee; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: flex; gap: 10px; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; flex-grow: 1; }
        button.btn-add { background: #27ae60; color: white; border: none; padding: 8px 15px; cursor: pointer; font-weight: bold; border-radius: 4px;}
        
        .item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .btn-restar { background: #e74c3c; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>üì¶ Inventario Interno</h1>

        <div class="formulario-add">
            <input type="text" id="nuevoNombre" placeholder="Ej: Walkie Talkie">
            <input type="number" id="nuevaCantidad" placeholder="Cant." style="max-width: 60px;">
            <button class="btn-add" onclick="agregarMaterial()">A√±adir</button>
        </div>
        
        <div id="lista-materiales">
            <p>Cargando datos...</p>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN ---
        // ¬°¬°¬°¬° PEGA AQU√ç TUS CLAVES OTRA VEZ !!!!
        const SU_URL = 'https://irmkphwdqavkzbgszkon.supabase.co';
        const SU_KEY = 'sb_publishable_YE4P7UxXiUbAMdXKBPRKYQ_RkrsgsDE';
        
        const clienteSupabase = supabase.createClient(SU_URL, SU_KEY);
        
        // Variable global para saber qui√©n es el usuario actual
        let usuarioActual = null;
        let perfilActual = null;

        // --- 2. SEGURIDAD Y BIENVENIDA ---
        async function verificarSesion() {
            // Verificamos si hay usuario logueado
            const { data: { session } } = await clienteSupabase.auth.getSession();

            if (!session) {
                // Si no hay sesi√≥n, ¬°FUERA!
                window.location.href = "index.html";
                return;
            }

            usuarioActual = session.user;

            // Buscamos sus datos personales en la tabla 'perfiles'
            const { data: perfil, error } = await clienteSupabase
                .from('perfiles')
                .select('*')
                .eq('id', usuarioActual.id)
                .single(); // .single() porque solo esperamos uno

            if (perfil) {
                perfilActual = perfil;
                // Cambiamos el t√≠tulo H1 para saludar
                document.querySelector('h1').innerText = `Hola, ${perfil.nombre} üëã`;
                
                // Si NO es admin, podr√≠amos ocultar cosas aqu√≠
                if (perfil.rol !== 'admin') {
                   // Por ejemplo: document.querySelector('.formulario-add').style.display = 'none';
                }
            }
            
            // Si pasamos el control de seguridad, cargamos el inventario
            cargarInventario();
        }

        // --- 3. LEER DATOS ---
        async function cargarInventario() {
            const { data, error } = await clienteSupabase
                .from('material')
                .select('*')
                .order('id', { ascending: false });

            if (error) { console.error(error); return; }

            let html = '';
            data.forEach(producto => {
                html += `
                    <div class="item">
                        <span>
                            <strong>${producto.nombre}</strong> 
                            (Stock: ${producto.cantidad})
                        </span>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn-restar" onclick="cogerMaterial(${producto.id}, ${producto.cantidad})">-1</button>
                            <button onclick="borrarMaterial(${producto.id})" style="background: #555; color: white; border: none; padding: 5px; border-radius: 4px;">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            document.getElementById('lista-materiales').innerHTML = html;
        }

        // --- 4. FUNCIONES DE ACCI√ìN (Iguales que antes) ---
        async function cogerMaterial(id, cant) {
            if (cant <= 0) return alert("No hay stock");
            await clienteSupabase.from('material').update({ cantidad: cant - 1 }).eq('id', id);
            cargarInventario();
        }

        async function borrarMaterial(id) {
            if (!confirm("¬øBorrar?")) return;
            await clienteSupabase.from('material').delete().eq('id', id);
            cargarInventario();
        }

        async function agregarMaterial() {
            const nombre = document.getElementById('nuevoNombre').value;
            const cant = document.getElementById('nuevaCantidad').value;
            if (!nombre || !cant) return;
            await clienteSupabase.from('material').insert({ nombre: nombre, cantidad: cant });
            document.getElementById('nuevoNombre').value = '';
            document.getElementById('nuevaCantidad').value = '';
            cargarInventario();
        }

        // --- ARRANCAR ---
        // En lugar de cargarInventario(), ahora llamamos primero al segurata
        verificarSesion();
    </script>
</body>
</html>
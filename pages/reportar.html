<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportar Incidencia - PC Aig√ºes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { pc: { orange: '#FF6600', blue: '#003366' } } } } }
    </script>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <nav class="bg-pc-blue text-white shadow-lg relative z-30">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="../index.html" class="flex items-center space-x-3 hover:opacity-90 transition group">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pc-blue font-bold shadow-sm group-hover:ring-2 ring-white transition overflow-hidden">
                    <img src="../assets/img/escudo.png" alt="PC" class="w-full h-full object-cover">
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-tight">Protecci√≥n Civil</h1>
                    <p class="text-xs text-pc-orange font-bold tracking-wider">AIG√úES</p>
                </div>
            </a>
            <a href="../index.html" class="text-sm font-bold uppercase text-gray-300 hover:text-white transition flex items-center bg-white/10 px-4 py-2 rounded-full">
                <span class="mr-2">‚Üê</span> Volver
            </a>
        </div>
    </nav>

    <header class="bg-pc-orange text-white py-8 text-center relative overflow-hidden z-10 shadow-md">
        <div class="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,_rgba(255,255,255,0.4)_0,_transparent_100%)]"></div>
        <div class="relative z-10 container mx-auto px-4">
            <h2 class="text-3xl font-bold mb-2 drop-shadow-sm">üì∏ Reporte Ciudadano</h2>
            <p class="text-orange-50 text-sm md:text-base font-medium">
                Indica la ubicaci√≥n y describe la incidencia.
            </p>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 -mt-6 relative z-20 mb-12">
        
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-3xl mx-auto border border-gray-200 p-5 md:p-8">
            
            <div class="mb-6 bg-blue-50 border border-blue-100 rounded-xl p-4">
                <label class="block text-sm font-bold text-blue-900 mb-2 flex justify-between items-center">
                    <span>üìç Ubicaci√≥n de la incidencia</span>
                    <button onclick="verAyudaGPS()" class="text-xs text-blue-500 underline font-normal hover:text-blue-700">¬øProblemas GPS?</button>
                </label>

                <div class="flex flex-col md:flex-row gap-3">
                    
                    <div class="relative flex-grow">
                        <input type="text" id="inputManual" 
                            placeholder="Ej: Calle Mayor 12 (o pulsa GPS ->)" 
                            class="w-full pl-4 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pc-orange focus:border-transparent outline-none transition text-gray-700 bg-white"
                            onchange="actualizarTallyManual(this.value)">
                    </div>

                    <button onclick="obtenerUbicacion()" id="btnGPS" class="group flex items-center justify-center bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-all active:scale-95 whitespace-nowrap min-w-[140px]">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span id="txtGPS">Usar GPS</span>
                    </button>
                </div>

                <p class="text-xs text-blue-800/60 mt-2 flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                    Selecciona la ubicaci√≥n antes de rellenar el formulario (se recargar√°).
                </p>
            </div>

            <hr class="border-gray-100 mb-6">

            <iframe id="tallyFrame"
                    data-original-src="https://tally.so/embed/2EP2ke?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1" 
                    src="https://tally.so/embed/2EP2ke?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1"
                    loading="lazy" 
                    width="100%" 
                    height="350" 
                    frameborder="0" 
                    marginheight="0" 
                    marginwidth="0" 
                    title="Reportar Incidencia"
                    class="w-full transition-opacity duration-300">
            </iframe>
            
        </div>
        
        <p class="text-center text-gray-400 text-xs mt-6">
            Para emergencias graves (fuego, heridos) llama al <span class="font-bold text-red-500">112</span>.
        </p>
    </main>

    <footer class="bg-gray-900 text-gray-500 py-6 text-center text-sm z-10">
        <p>&copy; 2026 Protecci√≥n Civil Aig√ºes.</p>
    </footer>

    <script async src="https://tally.so/widgets/embed.js"></script>

    <script>
        // --- 1. L√ìGICA MANUAL (Si escriben direcci√≥n) ---
        function actualizarTallyManual(texto) {
            if(!texto) return;
            const iframe = document.getElementById('tallyFrame');
            
            // Recargamos enviando el texto al campo oculto 'coordenadas' o 'direccion'
            // Nota: Usamos el mismo campo 'coordenadas' para simplificar en el Excel
            recargarIframe(iframe, texto);
        }

        // --- 2. L√ìGICA GPS "PLAN B" ---
        function obtenerUbicacion() {
            const btn = document.getElementById('btnGPS');
            const txt = document.getElementById('txtGPS');
            const input = document.getElementById('inputManual');
            
            if (btn.classList.contains('cursor-wait')) return;

            // Estado visual
            txt.innerText = "Buscando...";
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            btn.classList.add('bg-blue-400', 'cursor-wait');

            if (!navigator.geolocation) {
                alert("GPS no disponible en este dispositivo.");
                resetBtn();
                return;
            }

            // INTENTO 1: ALTA PRECISI√ìN (5 segs)
            navigator.geolocation.getCurrentPosition(
                (pos) => procesarExito(pos, true),
                (err) => {
                    console.log("Fallo GPS preciso, intentando WiFi...");
                    // INTENTO 2: BAJA PRECISI√ìN (Fallback)
                    navigator.geolocation.getCurrentPosition(
                        (pos) => procesarExito(pos, false),
                        (errTotal) => mostrarError(errTotal),
                        { enableHighAccuracy: false, timeout: 10000, maximumAge: 60000 }
                    );
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }

        function procesarExito(pos, esPreciso) {
            const lat = pos.coords.latitude;
            const long = pos.coords.longitude;
            const acc = Math.round(pos.coords.accuracy);
            
            const btn = document.getElementById('btnGPS');
            const txt = document.getElementById('txtGPS');
            const input = document.getElementById('inputManual');
            const iframe = document.getElementById('tallyFrame');

            // 1. Generamos enlace Maps
            const mapsLink = `http://maps.google.com/?q=${lat},${long}`;
            
            // 2. Lo ponemos en el input visual para que el usuario lo vea
            input.value = `üìç GPS Detectado (Precisi√≥n: ${acc}m)`;
            
            // 3. Enviamos a Tally
            recargarIframe(iframe, mapsLink);

            // 4. Feedback Visual
            setTimeout(() => {
                const color = esPreciso ? 'bg-green-600' : 'bg-orange-500';
                const texto = esPreciso ? 'GPS OK' : 'GPS Aprox';
                
                txt.innerText = texto;
                btn.className = `group flex items-center justify-center ${color} text-white font-bold py-3 px-6 rounded-lg shadow-md cursor-default whitespace-nowrap min-w-[140px]`;
                btn.onclick = null; // Bloquear para no recargar sin querer
                
                if (acc > 1000) alert(`Aviso: Ubicaci√≥n aproximada (Error: ${acc}m). Verifica si es correcta.`);
            }, 500);
        }

        // --- UTILIDADES ---

        function recargarIframe(iframe, valor) {
            // Cogemos la URL base original (sin par√°metros sucios)
            const originalUrl = iframe.getAttribute('data-original-src') || iframe.src.split('&coordenadas=')[0];
            
            // A√±adimos el par√°metro oculto para Tally
            // Aseg√∫rate de que en Tally creaste el "Hidden Field" llamado 'coordenadas'
            const nuevaUrl = `${originalUrl}&coordenadas=${encodeURIComponent(valor)}`;
            
            iframe.style.opacity = '0.3';
            iframe.src = nuevaUrl;
            
            setTimeout(() => iframe.style.opacity = '1', 800);
        }

        function mostrarError(error) {
            let msg = "Error desconocido.";
            if (error.code === 1) msg = "‚ö†Ô∏è Permiso denegado. Activa la ubicaci√≥n en el navegador.";
            if (error.code === 2) msg = "‚ö†Ô∏è Sin se√±al GPS/Red.";
            if (error.code === 3) msg = "‚ö†Ô∏è Tiempo agotado.";
            alert(msg);
            resetBtn();
        }

        function resetBtn() {
            const btn = document.getElementById('btnGPS');
            const txt = document.getElementById('txtGPS');
            txt.innerText = "Usar GPS";
            btn.className = "group flex items-center justify-center bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-all active:scale-95 whitespace-nowrap min-w-[140px]";
        }

        function verAyudaGPS() {
            alert("üí° MEJORAR PRECISI√ìN GPS:\n\n1. Activa el WiFi (aunque no conectes).\n2. Haz un '8' con el m√≥vil en el aire.\n3. Al√©jate de edificios altos.\n4. Desactiva el ahorro de bater√≠a.");
        }
    </script>

</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportar Incidencia - PC Aig√ºes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { theme: { extend: { colors: { pc: { orange: '#FF6600', blue: '#003366' } } } } }
    </script>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex flex-col">

    <nav class="bg-pc-blue text-white shadow-lg relative z-30">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="../index.html" class="flex items-center space-x-3 hover:opacity-90 transition group">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-pc-blue font-bold shadow-sm group-hover:ring-2 ring-white transition">
                    <img src="../assets/img/escudo.png" alt="PC" class="w-full h-full object-cover rounded-full">
                </div>
                <div>
                    <h1 class="text-lg font-bold leading-tight">Protecci√≥n Civil</h1>
                    <p class="text-xs text-pc-orange font-bold tracking-wider">AIG√úES</p>
                </div>
            </a>
            <a href="../index.html" class="text-sm font-bold uppercase text-gray-300 hover:text-white transition flex items-center bg-white/10 px-4 py-2 rounded-full">
                <span class="mr-2">‚Üê</span> Volver
            </a>
        </div>
    </nav>

    <header class="bg-pc-orange text-white py-10 text-center relative overflow-hidden z-10 shadow-md">
        <div class="absolute inset-0 opacity-10 bg-[radial-gradient(circle_at_center,_rgba(255,255,255,0.4)_0,_transparent_100%)]"></div>
        
        <div class="relative z-10 container mx-auto px-4">
            <h2 class="text-3xl md:text-4xl font-bold mb-3 drop-shadow-sm">üì∏ Reporte Ciudadano</h2>
            <p class="text-orange-50 max-w-xl mx-auto text-sm md:text-base font-medium">
                Tu colaboraci√≥n es vital. Ay√∫danos a mantener Aig√ºes seguro reportando desperfectos.
            </p>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 -mt-6 relative z-20 mb-12">
        
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden max-w-3xl mx-auto border border-gray-200 p-4 md:p-8 relative">
            
            <div class="mb-6 bg-blue-50 border border-blue-100 rounded-xl p-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="text-sm text-blue-800">
                    <p class="font-bold">üìç ¬øEst√°s en el lugar de la incidencia?</p>
                    <p class="text-blue-600/80 text-xs">Adjunta tu ubicaci√≥n exacta (GPS) autom√°ticamente.</p>
                </div>
                <button onclick="obtenerUbicacion()" id="btnGPS" class="group flex items-center bg-white text-blue-600 border border-blue-200 font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-blue-600 hover:text-white hover:border-transparent transition-all active:scale-95 text-sm whitespace-nowrap">
                    <svg class="w-5 h-5 mr-2 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span id="txtGPS">Adjuntar mi Ubicaci√≥n</span>
                </button>
            </div>

            <iframe id="tallyFrame"
                    data-original-src="https://tally.so/embed/2EP2ke?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1" 
                    src="https://tally.so/embed/2EP2ke?alignLeft=1&hideTitle=1&transparentBackground=1&dynamicHeight=1"
                    loading="lazy" 
                    width="100%" 
                    height="300" 
                    frameborder="0" 
                    marginheight="0" 
                    marginwidth="0" 
                    title="Reportar Incidencia"
                    class="w-full transition-opacity duration-300">
            </iframe>
            
        </div>
        
        <p class="text-center text-gray-500 text-xs mt-4 max-w-md mx-auto bg-gray-200/50 py-2 px-4 rounded-full">
            ‚ÑπÔ∏è Este formulario es para incidencias leves. <br class="md:hidden">
            <span class="font-bold text-red-600">Para emergencias graves llama siempre al 112.</span>
        </p>
    </main>

    <script>
        let watchID = null;

        function obtenerUbicacion() {
            const btn = document.getElementById('btnGPS');
            const txt = document.getElementById('txtGPS');
            const iframe = document.getElementById('tallyFrame');
            
            // Si ya estamos buscando, paramos
            if (btn.classList.contains('cursor-wait')) return;

            // 1. ESTADO INICIAL
            txt.innerText = "Calentando GPS (Espere)...";
            btn.classList.add('bg-blue-100', 'cursor-wait');
            
            if (!navigator.geolocation) {
                alert("Tu navegador no tiene GPS.");
                resetBtn();
                return;
            }

            const opciones = {
                enableHighAccuracy: true, // ¬°OBLIGATORIO!
                timeout: 15000,           // Damos 15 segundos para afinar
                maximumAge: 0             // Prohibido usar cach√© vieja
            };

            // 2. USAMOS WATCHPOSITION (Mirada cont√≠nua)
            // Esto se ejecuta muchas veces por segundo mientras afina
            watchID = navigator.geolocation.watchPosition(
                
                // A) SI ENCUENTRA SE√ëAL
                (position) => {
                    const lat = position.coords.latitude;
                    const long = position.coords.longitude;
                    const accuracy = position.coords.accuracy; // Error en metros

                    // Le mostramos al usuario la precisi√≥n actual
                    txt.innerText = `Afinando... Error: ${Math.round(accuracy)}m`;

                    // 3. CRITERIO DE √âXITO: ¬øEs buena la precisi√≥n? (< 30 metros)
                    if (accuracy <= 30) {
                        detenerGPS(); // Dejamos de buscar, ya es buena
                        guardarUbicacion(lat, long);
                    }
                },
                
                // B) SI DA ERROR
                (error) => {
                    console.warn("Error GPS:", error);
                    // No paramos inmediatamente, esperamos a ver si se arregla
                    // salvo que sea error cr√≠tico de permisos
                    if (error.code === 1) { 
                        detenerGPS();
                        alert("Permiso denegado. Activa la ubicaci√≥n.");
                        resetBtn();
                    }
                },
                opciones
            );

            // 4. TEMPORIZADOR DE SEGURIDAD
            // Si en 15 segundos no conseguimos precisi√≥n perfecta, nos quedamos con lo que haya
            setTimeout(() => {
                if (watchID !== null) {
                    detenerGPS();
                    alert("No logramos precisi√≥n perfecta, pero usaremos la mejor disponible.");
                    // Aqu√≠ podr√≠amos forzar una √∫ltima lectura si quisi√©ramos,
                    // pero normalmente el watchPosition ya habr√° guardado algo si pudo.
                    resetBtn(); 
                }
            }, 15000);
        }

        function detenerGPS() {
            if (watchID !== null) {
                navigator.geolocation.clearWatch(watchID);
                watchID = null;
            }
        }

        function guardarUbicacion(lat, long) {
            const btn = document.getElementById('btnGPS');
            const txt = document.getElementById('txtGPS');
            const iframe = document.getElementById('tallyFrame');

            // Creamos el enlace
            const mapsLink = `http://maps.google.com/?q=${lat},${long}`;
            
            // Recargamos Tally
            const originalUrl = iframe.getAttribute('data-original-src');
            const nuevaUrl = `${originalUrl}&coordenadas=${encodeURIComponent(mapsLink)}`;
            
            iframe.style.opacity = '0.5';
            iframe.src = nuevaUrl;

            setTimeout(() => {
                iframe.style.opacity = '1';
                txt.innerText = "‚úÖ Ubicaci√≥n EXACTA Adjuntada";
                btn.className = "flex items-center bg-green-100 text-green-700 border border-green-200 font-bold py-2 px-4 rounded-lg text-sm cursor-default";
                btn.onclick = null; // Bloqueamos bot√≥n
            }, 1000);
        }

        function resetBtn() {
            const btn = document.getElementById('btnGPS');
            const txt = document.getElementById('txtGPS');
            txt.innerText = "Reintentar Ubicaci√≥n";
            btn.classList.remove('bg-blue-100', 'cursor-wait');
            detenerGPS();
        }
    </script>

    <footer class="bg-gray-900 text-gray-500 py-6 text-center text-sm z-10">
        <p>&copy; 2026 Protecci√≥n Civil Aig√ºes. Colaboraci√≥n ciudadana.</p>
    </footer>

    <script async src="https://tally.so/widgets/embed.js"></script>

</body>
</html>